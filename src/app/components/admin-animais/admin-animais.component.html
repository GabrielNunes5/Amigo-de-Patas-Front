<main class="space-y-6 p-4">
    <section class="border-none shadow-lg rounded-lg bg-white">
        <div class="p-6">
            <div class="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center">
                <div class="flex flex-col sm:flex-row gap-4 flex-1">
                    <div class="relative flex-1">
                        <lucide-angular [img]="Search" class="absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"/>
                        <input
                        type="search"
                        placeholder="Buscar por nome..."
                        [ngModel]="searchTerm()"
                        (ngModelChange)="onSearchChange($event)"
                        class="pl-10 w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                    </div>
                    <div class="w-full sm:w-40">
                        <select
                        [ngModel]="filterTipo()"
                        (ngModelChange)="onFilterTipoChange($event)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="todos">Todos os tipos</option>
                        <option value="Cachorro">üêï Cachorros</option>
                        <option value="Gato">üê± Gatos</option>
                      </select>
                    </div>
                    <div class="w-full sm:w-40">
                        <select
                        [ngModel]="filterStatus()"
                        (ngModelChange)="onFilterStatusChange($event)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="todos">Todos</option>
                        <option value="Dispon√≠vel">Dispon√≠veis</option>
                        <option value="Adotado">Adotados</option>
                      </select>
                    </div>
                </div>
                <button 
                type="button"
                (click)="openNewForm()"
                class="bg-gradient-to-r from-blue-600 to-green-600 text-white px-4 py-2 rounded-md flex items-center hover:opacity-90 transition-opacity focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                <lucide-angular [img]="Plus" class="w-4 h-4 mr-2"/>
                Novo Animal
                </button>
            </div>
        </div>
    </section>
    <section class="border-none shadow-lg rounded-xl overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-300">
              <thead class="bg-gray-50">
              <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Foto
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Nome
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Tipo
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Idade
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Sexo
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Porte
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Status
                  </th>
                  <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                    A√ß√µes
                  </th>
              </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                @if (loading()) {
                  <tr>
                    <td colspan="8" class="px-6 py-4">
                      <div class="h-12 bg-gray-100 animate-pulse rounded">
                        <span>Carregando Animais...</span>
                      </div>
                    </td>
                  </tr>
                }
                @if (!loading() && filteredAnimais().length === 0) {
                  <tr>
                    <td colspan="8" class="text-center py-8 text-gray-500">
                        <div>
                          <lucide-angular [img]="Heart" class="w-12 h-12 mx-auto mb-2 text-gray-300"/>
                          <p>Nenhum animal encontrado</p>
                        </div>
                    </td>
                  </tr>
                }
                @if (saving()) {
                  <tr>
                    <td colspan="8" class="px-6 py-4">
                      <div class="h-12 bg-gray-100 animate-pulse rounded flex items-center">
                        <span>Salvando animal...</span>
                      </div>
                    </td>
                  </tr>
                } @else {
                  @for (animal of filteredAnimais(); track animal.animalId) {
                    <tr class="hover:bg-gray-300 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                          <img 
                          [src]="animal.animalImages[0]" 
                          [alt]="'Foto de ' + animal.animalName"
                          class="w-14 h-14 rounded-lg object-cover"
                          loading="lazy"/>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <span class="font-medium text-gray-900">
                            {{ animal.animalName }}
                          </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border border-gray-300 bg-gray-50">
                              <span>
                                {{ animal.animalSpecies === 'Cachorro' ? 'üêï' : 'üê±' }}
                              </span>
                              <span class="ml-1">
                                {{ animal.animalSpecies }}
                              </span>
                          </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-700">
                          {{ animal.animalAge }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-700">
                          {{ animal.animalSex }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-gray-700">
                          {{ animal.animalSize }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <span
                          [class]="getStatusColor(animal.animalAdopted) + ' px-2.5 py-0.5 rounded-full text-xs font-medium'">
                              {{ animal.animalAdopted ? 'Adotado' : "Dispon√≠vel" }}
                          </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                          <div class="flex justify-center gap-2">
                              <button 
                              type="button"
                              (click)="openEditForm(animal)"
                              class="p-2 border border-gray-300 rounded-md hover:bg-gray-50 focus:ring-2 focus:outline-none focus:ring-blue-500 transition-colors"
                              title="Editar">
                              <lucide-angular [img]="Pencil" class="w-4 h-4"/>
                              </button>
                              <button 
                              type="button"
                              (click)="openDeleteDialog(animal)"
                              class="p-2 border border-gray-300 rounded-md text-red-600 hover:text-red-700 hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors"
                              title="Excluir">
                              <lucide-angular [img]="Trash" class="w-4 h-4"/>
                              </button>
                          </div>
                        </td>
                    </tr>
                  }
                }
              </tbody>
          </table>
        </div>
    </section>
</main>

@if (isFormOpen()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60" (click)="!saving() && closeForm()">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto" (click)="$event.stopPropagation()">
      <div class="p-6">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-2">
            <lucide-angular [img]="selectedAnimal() ? Pencil : Plus" class="w-6 h-6 text-gray-600"/>
            <h2 class="text-lg font-medium text-gray-900">
              {{ selectedAnimal() ? 'Editar Animal' : 'Novo Animal' }}
            </h2>
          </div>
          <button 
            type="button" 
            (click)="!saving() && closeForm()"
            class="text-gray-400 hover:text-gray-600">
            <lucide-angular [img]="X" class="w-6 h-6"/>
          </button>
        </div>

        <form [formGroup]="animalForm" (ngSubmit)="handleSubmit()" class="space-y-6" novalidate>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label for="nome" class="text-sm font-medium mb-1 block text-gray-700">
                Nome <span class="text-red-500">*</span>
              </label>
              <input
                id="nome"
                type="text"
                formControlName="animalName"
                placeholder="Nome do animal"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"/>
              @if (isFieldInvalid('animalName')) {
                <span class="text-red-500 text-sm">{{ getFieldError('animalName') }}</span>
              }
            </div>
            <div>
              <label for="tipo" class="text-sm font-medium mb-1 block text-gray-700">
                Tipo <span class="text-red-500">*</span>
              </label>
              <select 
                id="tipo"
                formControlName="animalSpecies"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="Cachorro">üêï Cachorro</option>
                <option value="Gato">üê± Gato</option>
              </select>
            </div>
            <div>
              <label for="idade" class="text-sm font-medium mb-1 block text-gray-700">
                Idade <span class="text-red-500">*</span>
              </label>
              <input
                id="idade"
                type="text"
                formControlName="animalAge"
                placeholder="Ex: 2 anos"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label for="sexo" class="text-sm font-medium mb-1 block text-gray-700">
                Sexo <span class="text-red-500">*</span>
              </label>
              <select 
                id="sexo"
                formControlName="animalSex"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="Macho">Macho</option>
                <option value="F√™mea">F√™mea</option>
              </select>
            </div>
            <div>
              <label for="peso" class="text-sm font-medium mb-1 block text-gray-700">
                Peso (kg) <span class="text-red-500">*</span>
              </label>
              <input
                id="peso"
                type="number"
                formControlName="animalWeight"
                placeholder="Ex: 12.5"
                step="0.1"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label for="porte" class="text-sm font-medium mb-1 block text-gray-700">
                Porte <span class="text-red-500">*</span>
              </label>
              <select 
                id="porte"
                formControlName="animalSize"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="Pequeno">Pequeno</option>
                <option value="M√©dio">M√©dio</option>
                <option value="Grande">Grande</option>
              </select>
            </div>
            <div>
              <label for="cor" class="text-sm font-medium mb-1 block text-gray-700">Cor</label>
              <input
                id="cor"
                type="text"
                formControlName="animalColor"
                placeholder="Ex: Marrom"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label for="status" class="text-sm font-medium mb-1 block text-gray-700">Status</label>
              <select 
                id="status"
                formControlName="animalAdopted"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option [ngValue]="false">Dispon√≠vel</option>
                <option [ngValue]="true">Adotado</option>
              </select>
            </div>
          </div>
          <div>
            <label for="vacinas" class="text-sm font-medium mb-1 block text-gray-700">Vacinas</label>
            <input
              id="vacinas"
              type="text"
              formControlName="animalVaccines"
              placeholder="Ex: Antirr√°bica, V10"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"/>
          </div>
          <div>
            <label for="necessidades" class="text-sm font-medium mb-1 block text-gray-700">Condi√ß√µes Especiais</label>
            <textarea
              id="necessidades"
              formControlName="animalSpecialConditions"
              placeholder="Algum cuidado especial?"
              rows="2"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            ></textarea>
          </div>
          <div class="flex items-center space-x-2">
            <input
              type="checkbox"
              id="castrado"
              formControlName="animalNeutered"
              class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"/>
            <label for="castrado" class="text-sm font-medium text-gray-700">Castrado</label>
          </div>
          <div>
            <label for="imagens" class="text-sm font-medium mb-1 block text-gray-700">Imagens do Animal</label>
            <input
              id="imagens"
              type="file"
              (change)="onFileChange($event)"
              multiple
              accept="image/*"
              class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:border file:border-gray-300 file:rounded-md file:text-sm file:font-medium file:bg-gray-50 hover:file:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"/>
          </div>
          @if (imagesLoading()) {
            <div class="grid grid-cols-3 gap-2 mt-2">
              @for (i of [1,2,3]; track i) {
                <div class="h-24 bg-gray-200 animate-pulse rounded-md"></div>
              }
            </div>
          }
          @if (!imagesLoading() && selectedAnimal()) {
            <label class="text-sm font-medium mb-1 block text-gray-700">
              Galeria do Animal
            </label>
            <div class="grid grid-cols-3 gap-2 mt-2">
              @for (img of selectedAnimal()?.animalImages; track img) {
                  <div class="aspect-square overflow-hidden rounded-lg border border-gray-200">
                    <img 
                    [src]="img" 
                    [alt]="selectedAnimal()?.animalName"
                    (load)="onImageLoad()"
                    class="w-full h-full object-contain transition-transform duration-300 hover:scale-105"/>
                </div>
                }
            </div>
          }
          <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
            <button 
              type="button" 
              (click)="!saving() && closeForm()"
              class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
              Cancelar
            </button>
            <button 
              type="submit" 
              [disabled]="animalForm.invalid || saving() || imagesLoading()"
              class="bg-gradient-to-r from-blue-600 to-green-600 text-white px-4 py-2 rounded-md hover:opacity-90 disabled:opacity-50 transition-opacity">
              {{ saving() ? "Salvando..." : (selectedAnimal() ? "Atualizar" : "Criar") }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
}

@if (isDeleteOpen()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60" (click)="closeDeleteDialog()">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md" (click)="$event.stopPropagation()">
      <div class="p-6">
        <div class="flex items-start gap-4">
          <div class="w-12 h-12 rounded-full bg-red-00 flex items-center justify-center">
            <lucide-angular [img]="TriangleAlert" class="w-8 h-8 text-red-600"/>
          </div>
          <div class="flex-1">
            <h2 class="text-lg font-medium text-gray-900 mb-2">Confirmar Exclus√£o</h2>
            <p class="text-sm text-gray-500">
              Tem certeza que deseja excluir o animal <strong>"{{ selectedAnimal()?.animalName }}"</strong>?
              Esta a√ß√£o n√£o pode ser desfeita.
            </p>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-6 py-3 flex justify-end gap-3">
        <button 
          type="button" 
          (click)="closeDeleteDialog()"
          class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">
          Cancelar
        </button>
        <button 
          type="button" 
          (click)="handleDelete()"
          class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
          Excluir
        </button>
      </div>
    </div>
  </div>
}